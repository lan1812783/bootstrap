---
- name: Check if there is currently any installation available
  command: nvim -v
  register: nvim_version
  ignore_errors: true
  changed_when: false

- name: Install build prerequisites for Ubuntu
  become: true
  package:
    name:
      - ninja-build
      - gettext
      - cmake
      - unzip
      - curl
  when: nvim_version.rc != 0 and ansible_distribution == 'Ubuntu'

- name: Install build prerequisites for MacOS
  package:
    name:
      - ninja
      - cmake
      - gettext
      - curl
  when: nvim_version.rc != 0 and ansible_distribution == 'MacOSX'

- name: Install plugins' dependencies
  become: "{{ false if ansible_distribution == 'MacOSX' else true }}"
  package:
    name:
      - ripgrep
  when: nvim_version.rc != 0

- name: Create a directory for storing repositories
  file:
    path: '{{ dep_dir_path }}'
    state: directory
  when: nvim_version.rc != 0

- name: Clone the repository
  git:
    repo: https://github.com/neovim/neovim
    dest: '{{ dep_dir_path }}/neovim'
    version: stable
  when: nvim_version.rc != 0

- name: Build the stable release
  community.general.make:
    chdir: '{{ dep_dir_path }}/neovim'
    jobs: 4
    params:
      CMAKE_BUILD_TYPE: RelWithDebInfo
  when: nvim_version.rc != 0

- name: Install the binary
  become: true
  community.general.make:
    chdir: '{{ dep_dir_path }}/neovim'
    target: install
  when: nvim_version.rc != 0
